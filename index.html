<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ISSI Screener ‚Äî Saham Syariah IDX</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #ffffff;
  --bg2: #f5f6f8;
  --bg3: #eef0f3;
  --border: #dde1e7;
  --border2: #c8cdd6;
  --text: #1a1d23;
  --text2: #4a5060;
  --text3: #8a919e;
  --accent: #1a56db;
  --accent-bg: #eff4ff;
  --accent-hover: #1645b0;
  --green: #057a55;
  --green-bg: #def7ec;
  --red: #c81e1e;
  --red-bg: #fde8e8;
  --yellow: #92400e;
  --yellow-bg: #fef3c7;
  --orange: #9a3412;
  --orange-bg: #ffedd5;
  --purple: #5521b5;
  --purple-bg: #edebfe;
  --teal: #005661;
  --teal-bg: #d0f7fa;
  --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
  --font: 'IBM Plex Sans', sans-serif;
  --mono: 'IBM Plex Mono', monospace;
  --radius: 6px;
  --radius-sm: 4px;
}
[data-theme="dark"] {
  --bg: #111318;
  --bg2: #1a1d24;
  --bg3: #22262f;
  --border: #2e3340;
  --border2: #3d4454;
  --text: #e8eaf0;
  --text2: #9aa0b0;
  --text3: #5c6370;
  --accent: #4d8af0;
  --accent-bg: #1a2540;
  --accent-hover: #6b9ff5;
  --green: #31c48d;
  --green-bg: #052e20;
  --red: #f05252;
  --red-bg: #2d1515;
  --yellow: #f6c90e;
  --yellow-bg: #2d2505;
  --orange: #fb923c;
  --orange-bg: #2d1a05;
  --purple: #a78bfa;
  --purple-bg: #1e1640;
  --teal: #22d3ee;
  --teal-bg: #062025;
  --shadow: 0 1px 3px rgba(0,0,0,0.3), 0 1px 2px rgba(0,0,0,0.2);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.3), 0 2px 4px rgba(0,0,0,0.2);
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 14px; }
body {
  font-family: var(--font);
  background: var(--bg2);
  color: var(--text);
  min-height: 100vh;
  line-height: 1.5;
  transition: background 0.2s, color 0.2s;
}

/* TOPBAR */
.topbar {
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  padding: 0 1.5rem;
  display: flex;
  align-items: center;
  height: 56px;
  position: sticky; top: 0; z-index: 100;
  box-shadow: var(--shadow);
  gap: 1rem;
}
.topbar-brand {
  display: flex; align-items: center; gap: 0.5rem;
  font-weight: 700; font-size: 1rem; letter-spacing: -0.01em;
  color: var(--text);
  flex-shrink: 0;
}
.brand-icon {
  width: 28px; height: 28px;
  background: var(--accent);
  border-radius: var(--radius-sm);
  display: grid; place-items: center;
  font-size: 0.65rem; font-weight: 700;
  color: white; letter-spacing: 0.02em;
}
.topbar-meta {
  display: flex; align-items: center; gap: 1.25rem;
  font-size: 0.78rem; color: var(--text3);
  flex: 1;
}
.meta-item { display: flex; align-items: center; gap: 0.3rem; }
.meta-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--green); flex-shrink: 0;
}
.meta-dot.idle { background: var(--text3); }
.meta-dot.loading { background: var(--accent); animation: blink 1s infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

.topbar-right { display: flex; align-items: center; gap: 0.5rem; margin-left: auto; }
.btn-icon {
  display: flex; align-items: center; gap: 0.35rem;
  padding: 0.35rem 0.75rem;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: var(--bg);
  color: var(--text2);
  font-family: var(--font);
  font-size: 0.78rem;
  cursor: pointer;
  transition: all 0.15s;
  font-weight: 500;
}
.btn-icon:hover { background: var(--bg3); border-color: var(--border2); color: var(--text); }
.btn-icon.active { background: var(--bg3); color: var(--text); }

.btn-fetch {
  display: flex; align-items: center; gap: 0.4rem;
  padding: 0.4rem 1rem;
  border-radius: var(--radius-sm);
  border: none;
  background: var(--accent);
  color: white;
  font-family: var(--font);
  font-size: 0.8rem;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.15s;
  white-space: nowrap;
}
.btn-fetch:hover { background: var(--accent-hover); }
.btn-fetch:disabled { opacity: 0.6; cursor: not-allowed; }
.btn-fetch svg { flex-shrink: 0; }

/* PROGRESS */
.progress-wrap {
  height: 2px; background: var(--border);
  position: sticky; top: 56px; z-index: 99;
}
.progress-fill {
  height: 100%; background: var(--accent);
  transition: width 0.3s ease;
  width: 0%;
}

/* MAIN */
.container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }

/* PANEL CARD */
.card {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-bottom: 1rem;
  overflow: hidden;
}
.card-body { padding: 1rem 1.25rem; }

/* SEARCH */
.search-wrap {
  position: relative;
}
.search-icon {
  position: absolute; left: 0.85rem; top: 50%;
  transform: translateY(-50%);
  color: var(--text3);
  pointer-events: none;
}
.search-input {
  width: 100%;
  padding: 0.6rem 0.85rem 0.6rem 2.3rem;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg);
  color: var(--text);
  font-family: var(--font);
  font-size: 0.875rem;
  outline: none;
  transition: border-color 0.15s, box-shadow 0.15s;
}
.search-input::placeholder { color: var(--text3); }
.search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 15%, transparent); }

/* FILTER SECTION */
.filter-section { padding: 0.85rem 1.25rem; border-bottom: 1px solid var(--border); }
.filter-label {
  font-size: 0.7rem; font-weight: 700; letter-spacing: 0.1em;
  color: var(--text3); text-transform: uppercase;
  display: flex; align-items: center; gap: 0.3rem;
  margin-bottom: 0.6rem;
}
.filter-label::before { content:''; width:3px; height:12px; background:var(--accent); border-radius:2px; display:inline-block; }

.tag-group { display: flex; flex-wrap: wrap; gap: 0.4rem; }
.tag {
  padding: 0.3rem 0.75rem;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--bg);
  color: var(--text2);
  font-family: var(--font);
  font-size: 0.78rem;
  cursor: pointer;
  transition: all 0.15s;
  font-weight: 500;
  user-select: none;
}
.tag:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-bg); }
.tag.active { background: var(--accent); border-color: var(--accent); color: white; font-weight: 600; }

/* MA FILTER */
.ma-filter-grid {
  display: flex; flex-wrap: wrap; gap: 0.4rem;
}
.ma-tag {
  padding: 0.25rem 0.65rem;
  border-radius: 4px;
  border: 1px solid var(--border);
  background: var(--bg);
  color: var(--text2);
  font-family: var(--mono);
  font-size: 0.72rem;
  cursor: pointer;
  transition: all 0.15s;
  font-weight: 500;
  user-select: none;
  letter-spacing: 0.02em;
}
.ma-tag:hover { border-color: var(--green); color: var(--green); }
.ma-tag.active { background: var(--green-bg); border-color: var(--green); color: var(--green); font-weight: 700; }

/* PERIOD ROW */
.period-row { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
.select-wrap select {
  padding: 0.35rem 1.8rem 0.35rem 0.65rem;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg);
  color: var(--text);
  font-family: var(--font);
  font-size: 0.8rem;
  cursor: pointer;
  outline: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238a919e' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0.5rem center;
  transition: border-color 0.15s;
}
.select-wrap select:focus { border-color: var(--accent); }
.btn-reset {
  padding: 0.35rem 0.75rem;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg);
  color: var(--text2);
  font-family: var(--font);
  font-size: 0.78rem;
  cursor: pointer;
  transition: all 0.15s;
}
.btn-reset:hover { border-color: var(--border2); color: var(--text); }

/* STATS BAR */
.stats-row {
  display: flex; align-items: center; gap: 1.5rem;
  padding: 0.6rem 1.25rem;
  border-bottom: 1px solid var(--border);
  font-size: 0.78rem;
  color: var(--text3);
  flex-wrap: wrap;
}
.stat-pill { display: flex; align-items: center; gap: 0.3rem; }
.stat-pill strong { color: var(--text); font-weight: 600; }
.stat-pill.bull strong { color: var(--green); }
.stat-pill.bear strong { color: var(--red); }
.stat-pill.above strong { color: var(--accent); }

/* TABLE */
.table-scroll { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
thead th {
  padding: 0.6rem 0.75rem;
  text-align: left;
  font-weight: 600;
  color: var(--text2);
  font-size: 0.72rem;
  letter-spacing: 0.03em;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
  cursor: pointer;
  user-select: none;
  background: var(--bg2);
  transition: color 0.15s;
}
thead th:hover { color: var(--text); }
thead th.sort-asc::after { content: ' ‚Üë'; color: var(--accent); }
thead th.sort-desc::after { content: ' ‚Üì'; color: var(--accent); }
thead th:first-child { padding-left: 1.25rem; }

tbody tr {
  border-bottom: 1px solid var(--border);
  transition: background 0.1s;
}
tbody tr:hover { background: var(--bg2); }
tbody tr:last-child { border-bottom: none; }
tbody td {
  padding: 0.55rem 0.75rem;
  white-space: nowrap;
  vertical-align: middle;
}
tbody td:first-child { padding-left: 1.25rem; }

.td-no { color: var(--text3); font-size: 0.72rem; width: 32px; }
.td-ticker {
  font-family: var(--mono);
  font-weight: 600;
  font-size: 0.82rem;
  color: var(--accent);
}
.td-company {
  max-width: 160px;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text2);
  font-size: 0.75rem;
}
.td-price { font-family: var(--mono); font-weight: 600; }
.td-pct { font-family: var(--mono); font-size: 0.75rem; font-weight: 600; }
.td-val { font-family: var(--mono); font-size: 0.75rem; }
.td-ind { font-family: var(--mono); font-size: 0.75rem; }

.up { color: var(--green); }
.down { color: var(--red); }
.neu { color: var(--text3); }

/* BADGE */
.badge {
  display: inline-flex; align-items: center;
  padding: 1px 6px;
  border-radius: 4px;
  font-size: 0.67rem;
  font-weight: 700;
  letter-spacing: 0.03em;
  line-height: 1.6;
}
.badge-bull { background: var(--green-bg); color: var(--green); }
.badge-bear { background: var(--red-bg); color: var(--red); }
.badge-neu { background: var(--bg3); color: var(--text3); }

/* MA CELL badges */
.ma-cell { display: flex; gap: 2px; flex-wrap: wrap; }
.ma-pip {
  width: 18px; height: 18px;
  border-radius: 3px;
  font-size: 0.58rem;
  font-weight: 700;
  display: grid; place-items: center;
  font-family: var(--mono);
}
.ma-pip.above { background: var(--green-bg); color: var(--green); }
.ma-pip.below { background: var(--red-bg); color: var(--red); }

/* RSI gauge */
.rsi-wrap { display: flex; align-items: center; gap: 0.4rem; }
.rsi-bar { width: 50px; height: 4px; background: var(--bg3); border-radius: 2px; overflow: hidden; flex-shrink: 0; }
.rsi-fill { height: 100%; border-radius: 2px; }

/* EMPTY / ERROR */
.table-empty {
  padding: 3rem; text-align: center;
  color: var(--text3); font-size: 0.85rem;
}
.table-empty .icon { font-size: 2rem; margin-bottom: 0.5rem; }

/* SKELETON */
@keyframes skeleton { 0%{opacity:0.5} 50%{opacity:1} 100%{opacity:0.5} }
.skel { animation: skeleton 1.2s infinite; background: var(--bg3); border-radius: 3px; display: inline-block; height: 12px; }

/* TOAST */
.toast-wrap {
  position: fixed; bottom: 1.5rem; right: 1.5rem;
  display: flex; flex-direction: column; gap: 0.4rem;
  z-index: 999;
}
.toast {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 0.6rem 1rem;
  font-size: 0.8rem;
  color: var(--text);
  box-shadow: var(--shadow-md);
  transform: translateX(110%);
  transition: transform 0.3s cubic-bezier(.4,0,.2,1);
  max-width: 300px;
}
.toast.show { transform: translateX(0); }
.toast.success { border-left: 3px solid var(--green); }
.toast.error { border-left: 3px solid var(--red); }
.toast.info { border-left: 3px solid var(--accent); }

/* FETCH STATUS */
.fetch-status {
  padding: 0.75rem 1.25rem;
  font-size: 0.78rem; color: var(--text2);
  border-top: 1px solid var(--border);
  display: flex; align-items: center; gap: 0.5rem;
}
.fetch-status span.highlight { color: var(--accent); font-weight: 600; font-family: var(--mono); }

/* No data banner */
.no-data-banner {
  margin: 1.5rem 0;
  padding: 1.5rem;
  border: 1px dashed var(--border2);
  border-radius: var(--radius);
  text-align: center;
  color: var(--text3);
  background: var(--bg);
}
.no-data-banner strong { display: block; color: var(--text); font-size: 0.9rem; margin-bottom: 0.4rem; }

/* RESPONSIVE */
@media (max-width: 900px) {
  .topbar-meta { display: none; }
  .container { padding: 1rem; }
}
@media (max-width: 600px) {
  .topbar { padding: 0 1rem; }
  .topbar-brand span { display: none; }
}
</style>
</head>
<body>

<!-- TOPBAR -->
<header class="topbar">
  <div class="topbar-brand">
    <div class="brand-icon">IDX</div>
    <span>ISSI Screener</span>
  </div>
  <div class="topbar-meta">
    <div class="meta-item">
      <span class="meta-dot idle" id="statusDot"></span>
      <span id="statusText">Belum ada data</span>
    </div>
    <div class="meta-item" id="lastFetchWrap" style="display:none">
      <span>üïê</span>
      <span id="lastFetchTime">‚Äî</span>
    </div>
  </div>
  <div class="topbar-right">
    <button class="btn-icon" id="darkToggle" onclick="toggleDark()" title="Toggle Dark Mode">
      <span id="darkIcon">üåô</span> <span id="darkLabel">Dark</span>
    </button>
    <button class="btn-fetch" id="fetchBtn" onclick="startFetch()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
      Ambil Data Saham
    </button>
  </div>
</header>

<div class="progress-wrap"><div class="progress-fill" id="progressFill"></div></div>

<div class="container">

  <!-- SEARCH -->
  <div class="card" style="margin-bottom:1rem">
    <div class="card-body">
      <div class="search-wrap">
        <svg class="search-icon" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input class="search-input" id="searchInput" placeholder="Cari ticker atau nama perusahaan..." type="text" oninput="applyFilters()">
      </div>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="card" style="margin-bottom:1rem">

    <!-- FILTER SINYAL -->
    <div class="filter-section">
      <div class="filter-label">Filter Sinyal</div>
      <div class="tag-group">
        <span class="tag active" id="sig-all" onclick="setSig('all')">Semua</span>
        <span class="tag" id="sig-bull" onclick="setSig('bull')">‚ñ≤ Bullish Dominan</span>
        <span class="tag" id="sig-bear" onclick="setSig('bear')">‚ñº Bearish Dominan</span>
        <span class="tag" id="sig-above4" onclick="setSig('above4')">‚Üë Di atas EMA3/5/10/20</span>
        <span class="tag" id="sig-rsi-ob" onclick="setSig('rsi-ob')">RSI Overbought (>70)</span>
        <span class="tag" id="sig-rsi-os" onclick="setSig('rsi-os')">RSI Oversold (&lt;30)</span>
      </div>
    </div>

    <!-- FILTER MA -->
    <div class="filter-section" style="border-bottom:none">
      <div class="filter-label">Filter Moving Average (harga tutup <em>di atas</em> MA)</div>
      <div class="ma-filter-grid" id="maFilters">
        <span class="ma-tag" id="maf-ema3" onclick="toggleMA('ema3')">EMA 3</span>
        <span class="ma-tag" id="maf-ema5" onclick="toggleMA('ema5')">EMA 5</span>
        <span class="ma-tag" id="maf-ema10" onclick="toggleMA('ema10')">EMA 10</span>
        <span class="ma-tag" id="maf-ema20" onclick="toggleMA('ema20')">EMA 20</span>
        <span class="ma-tag" id="maf-sma50" onclick="toggleMA('sma50')">SMA 50</span>
        <span class="ma-tag" id="maf-sma100" onclick="toggleMA('sma100')">SMA 100</span>
        <span class="ma-tag" id="maf-sma200" onclick="toggleMA('sma200')">SMA 200</span>
        <span class="btn-reset" style="font-size:0.72rem;padding:0.2rem 0.5rem" onclick="resetMAFilters()">Reset MA</span>
      </div>
    </div>

  </div>

  <!-- TABLE CARD -->
  <div class="card" id="mainCard">

    <!-- STATS -->
    <div class="stats-row" id="statsRow" style="display:none">
      <span class="stat-pill">Total: <strong id="st-total">0</strong></span>
      <span class="stat-pill">Tampil: <strong id="st-shown">0</strong></span>
      <span class="stat-pill bull">Bullish: <strong id="st-bull">0</strong></span>
      <span class="stat-pill bear">Bearish: <strong id="st-bear">0</strong></span>
      <span class="stat-pill above">Di atas EMA4: <strong id="st-above">0</strong></span>
    </div>

    <!-- FETCH STATUS DURING LOADING -->
    <div class="fetch-status" id="fetchStatus" style="display:none">
      <span id="fetchStatusText">Memproses saham...</span>
    </div>

    <div class="table-scroll">
      <table id="mainTable">
        <thead>
          <tr>
            <th class="td-no">NO</th>
            <th onclick="sortBy('ticker')">TICKER</th>
            <th onclick="sortBy('company')">NAMA</th>
            <th onclick="sortBy('price')">HARGA</th>
            <th onclick="sortBy('pct')">% CHG</th>
            <th title="EMA3 EMA5 EMA10 EMA20 SMA50 SMA100 SMA200">MA SINYAL</th>
            <th onclick="sortBy('rsi')">RSI(14)</th>
            <th onclick="sortBy('stochRsi')">Stoch RSI</th>
            <th onclick="sortBy('atr')">ATR(14)</th>
            <th onclick="sortBy('adr')">ADR%</th>
            <th onclick="sortBy('lastValue')">TRX HARI INI</th>
            <th onclick="sortBy('avg20Value')">AVG TRX 20H</th>
            <th onclick="sortBy('pct1avg20')">1% AVG 20H</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="13"><div class="table-empty"><div class="icon">üìä</div>Klik "Ambil Data Saham" untuk memulai screening</div></td></tr>
        </tbody>
      </table>
    </div>

  </div>

  <div style="font-size:0.7rem;color:var(--text3);text-align:center;margin-top:0.75rem;padding-bottom:1.5rem">
    ‚ö†Ô∏è Data dari Yahoo Finance. Bukan rekomendasi investasi. Gunakan untuk referensi analisis mandiri.
  </div>
</div>

<!-- TOAST -->
<div class="toast-wrap" id="toastWrap"></div>

<script>
// =============================================
// CONSTANTS
// =============================================
const TICKERS = ["AADI","AALI","ABMM","ACES","ACST","ADCP","ADES","ADHI","ADMG","ADMR","ADRO","AGAR","AGII","AIMS","AISA","AKKU","AKPI","AKRA","AKSI","ALDO","ALKA","AMAN","AMFG","AMIN","ANDI","ANJT","ANTM","APII","APLI","APLN","ARCI","AREA","ARGO","ARII","ARNA","ARTA","ASGR","ASHA","ASII","ASLC","ASLI","ASPI","ASRI","ASSA","ATAP","ATIC","ATLA","AUTO","AVIA","AWAN","AXIO","AYAM","AYLS","BABY","BAIK","BANK","BAPI","BATA","BATR","BAUT","BAYU","BBRM","BBSS","BCIP","BDKR","BEEF","BELI","BELL","BESS","BEST","BIKE","BINO","BIPP","BIRD","BISI","BKDP","BKSL","BLES","BLOG","BLTA","BLTZ","BLUE","BMHS","BMSR","BMTR","BNBR","BOAT","BOBA","BOGA","BOLA","BOLT","BRAM","BRIS","BRMS","BRNA","BRPT","BRRC","BSBK","BSDE","BSML","BSSR","BTPS","BUAH","BUKK","BULL","BUMI","BUVA","BYAN","CAKK","CAMP","CANI","CARE","CASS","CBDK","CBPE","CBRE","CCSI","CEKA","CGAS","CHEK","CHEM","CINT","CITA","CITY","CLEO","CLPI","CMNP","CMPP","CMRY","CNKO","CNMA","COAL","CPIN","CPRO","CRAB","CRSN","CSAP","CSIS","CSMI","CSRA","CTBN","CTRA","CYBR","DAAZ","DADA","DATA","DAYA","DCII","DEFI","DEPO","DEWA","DEWI","DGIK","DGNS","DGWG","DILD","DIVA","DKFT","DKHH","DMAS","DMMX","DMND","DOOH","DOSS","DRMA","DSFI","DSNG","DSSA","DUTI","DVLA","DWGL","DYAN","EAST","ECII","EDGE","EKAD","ELIT","ELPI","ELSA","ELTY","EMDE","ENAK","ENRG","EPAC","EPMT","ERAA","ERAL","ESIP","ESSA","ESTA","EXCL","FAST","FASW","FILM","FIRE","FISH","FITT","FMII","FOLK","FOOD","FORE","FPNI","FUTR","FWCT","GDST","GDYR","GEMA","GEMS","GGRP","GHON","GIAA","GJTL","GLVA","GMTD","GOLD","GOLF","GOOD","GPRA","GPSO","GRIA","GRPH","GTBO","GTRA","GTSI","GULA","GUNA","GWSA","GZCO","HADE","HAIS","HALO","HATM","HDIT","HEAL","HERO","HEXA","HGII","HITS","HOKI","HOMI","HOPE","HRME","HRUM","HUMI","HYGN","IATA","IBST","ICBP","ICON","IDPR","IFII","IFSH","IGAR","IIKP","IKAI","IKAN","IKBI","IKPM","IMPC","INCI","INCO","INDF","INDR","INDS","INDX","INDY","INET","INKP","INPP","INTD","INTP","IOTF","IPCC","IPCM","IPOL","IPTV","IRRA","IRSX","ISAT","ISSP","ITMA","ITMG","JAST","JATI","JAWA","JAYA","JECC","JGLE","JIHD","JKON","JMAS","JPFA","JRPT","JSMR","JSPT","JTPE","KAQI","KARW","KBAG","KBLI","KBLM","KDSI","KDTN","KEEN","KEJU","KETR","KIAS","KICI","KIJA","KINO","KIOS","KJEN","KKES","KKGI","KLAS","KLBF","KMDS","KOBX","KOCI","KOIN","KOKA","KONI","KOPI","KOTA","KPIG","KREN","KRYA","KSIX","KUAS","LABA","LABS","LAJU","LAND","LCKM","LION","LIVE","LMPI","LMSH","LPCK","LPIN","LPKR","LPLI","LPPF","LRNA","LSIP","LTLS","LUCK","MAHA","MAIN","MAPA","MAPB","MAPI","MARK","MAXI","MBAP","MBMA","MBTO","MCAS","MCOL","MDIY","MDKA","MDKI","MDLA","MEDC","MEDS","MERI","MERK","META","MFMI","MGNA","MHKI","MICE","MIDI","MIKA","MINA","MINE","MIRA","MITI","MKAP","MKPI","MKTR","MLIA","MLPL","MLPT","MMIX","MMLP","MNCN","MORA","MPIX","MPMX","MPOW","MPPA","MPRO","MRAT","MSIN","MSJA","MSKY","MSTI","MTDL","MTEL","MTFN","MTLA","MTMH","MTPS","MTSM","MUTU","MYOH","MYOR","NAIK","NASA","NASI","NCKL","NELY","NEST","NETV","NFCX","NICE","NICL","NIKL","NPGF","NRCA","NTBK","NZIA","OASA","OBAT","OBMD","OILS","OKAS","OMED","OMRE","PADA","PALM","PAMG","PANI","PANR","PART","PBID","PBSA","PCAR","PDES","PDPP","PEHA","PEVE","PGAS","PGEO","PGLI","PGUN","PICO","PIPA","PJAA","PJHB","PKPK","PLIN","PMJS","PMUI","PNBS","PNGO","PNSE","POLI","POLU","PORT","POWR","PPRE","PPRI","PPRO","PRAY","PRDA","PRIM","PSAB","PSAT","PSDN","PSGO","PSKT","PSSI","PTBA","PTIS","PTMP","PTMR","PTPP","PTPS","PTPW","PTSN","PTSP","PURA","PURI","PWON","PZZA","RAAM","RAFI","RAJA","RALS","RANC","RATU","RBMS","RDTX","RGAS","RIGS","RISE","RMKE","RMKO","ROCK","RODA","RONY","ROTI","RSGK","RUIS","SAFE","SAGE","SAME","SAMF","SAPX","SATU","SBMA","SCCO","SCNP","SCPI","SEMA","SGER","SGRO","SHID","SHIP","SICO","SIDO","SILO","SIMP","SIPD","SKBM","SKLT","SKRN","SLIS","SMAR","SMBR","SMCB","SMDM","SMDR","SMGA","SMGR","SMIL","SMKL","SMLE","SMMT","SMRA","SMSM","SNLK","SOCI","SOHO","SOLA","SONA","SOSS","SOTS","SPMA","SPTO","SRTG","SSIA","SSTM","STAA","STTP","SULI","SUNI","SUPR","SURI","SWID","TALF","TAMA","TAMU","TAPG","TARA","TAXI","TBMS","TCID","TCPI","TEBE","TFAS","TFCO","TGKA","TGUK","TINS","TIRA","TIRT","TKIM","TLDN","TLKM","TMAS","TMPO","TNCA","TOBA","TOOL","TOSK","TOTL","TOTO","TPIA","TPMA","TRIS","TRJA","TRON","TRST","TRUE","TRUK","TSPC","TYRE","UANG","UCID","UFOE","ULTJ","UNIC","UNIQ","UNTR","UNVR","UVCR","VAST","VERN","VICI","VISI","VKTR","VOKS","WAPO","WEGE","WEHA","WINR","WINS","WIRG","WMUU","WOOD","WOWS","WTON","YELO","YPAS","YUPI","ZATA","ZONE","ZYRX"];
const STORAGE_KEY = 'issi_screener_v2';

// =============================================
// STATE
// =============================================
let allData = [];
let displayData = [];
let isFetching = false;
let sigFilter = 'all';
let maFilter = new Set();
let sortCol = 'pct';
let sortDir = -1;

// =============================================
// DARK MODE
// =============================================
(function initTheme(){
  const saved = localStorage.getItem('issi_theme') || 'light';
  document.documentElement.setAttribute('data-theme', saved);
  updateDarkBtn(saved);
})();

function toggleDark() {
  const cur = document.documentElement.getAttribute('data-theme');
  const next = cur === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('issi_theme', next);
  updateDarkBtn(next);
}
function updateDarkBtn(t) {
  document.getElementById('darkIcon').textContent = t === 'dark' ? '‚òÄÔ∏è' : 'üåô';
  document.getElementById('darkLabel').textContent = t === 'dark' ? 'Light' : 'Dark';
}

// =============================================
// MATH HELPERS
// =============================================
function ema(arr, p) {
  if (arr.length < p) return null;
  const k = 2 / (p + 1);
  let v = arr.slice(0, p).reduce((a, b) => a + b, 0) / p;
  for (let i = p; i < arr.length; i++) v = arr[i] * k + v * (1 - k);
  return v;
}
function sma(arr, p) {
  if (arr.length < p) return null;
  return arr.slice(-p).reduce((a, b) => a + b, 0) / p;
}
function rsi14(arr) {
  const p = 14;
  if (arr.length < p + 1) return null;
  const s = arr.slice(-p - 1);
  let g = 0, l = 0;
  for (let i = 1; i < s.length; i++) {
    const d = s[i] - s[i-1];
    if (d > 0) g += d; else l -= d;
  }
  const ag = g / p, al = l / p;
  if (al === 0) return 100;
  return 100 - 100 / (1 + ag / al);
}
function stochRSI(arr, rp=14, sp=14) {
  if (arr.length < rp + sp + 2) return null;
  const rArr = [];
  for (let i = rp; i < arr.length; i++) {
    const r = rsi14(arr.slice(0, i + 1));
    if (r !== null) rArr.push(r);
  }
  if (rArr.length < sp) return null;
  const recent = rArr.slice(-sp);
  const mn = Math.min(...recent), mx = Math.max(...recent);
  if (mx === mn) return 50;
  return ((rArr[rArr.length-1] - mn) / (mx - mn)) * 100;
}
function calcATR(highs, lows, closes, p=14) {
  if (highs.length < p + 1) return null;
  const trs = [];
  for (let i = 1; i < highs.length; i++) {
    const tr = Math.max(
      highs[i] - lows[i],
      Math.abs(highs[i] - closes[i-1]),
      Math.abs(lows[i] - closes[i-1])
    );
    trs.push(tr);
  }
  return sma(trs, p);
}
function calcADR(highs, lows, p=14) {
  // Average Daily Range % = avg((H-L)/L) over p days
  if (highs.length < p) return null;
  const h = highs.slice(-p), l = lows.slice(-p);
  let sum = 0;
  for (let i = 0; i < p; i++) sum += (h[i] - l[i]) / l[i];
  return (sum / p) * 100;
}

// =============================================
// FETCH
// =============================================
async function fetchOne(ticker) {
  const sym = ticker + '.JK';
  const url = `https://query1.finance.yahoo.com/v8/finance/chart/${sym}?interval=1d&range=1y`;
  const proxy = `https://corsproxy.io/?${encodeURIComponent(url)}`;
  try {
    const res = await fetch(proxy, { signal: AbortSignal.timeout(9000) });
    if (!res.ok) throw new Error(res.status);
    const j = await res.json();
    const r = j?.chart?.result?.[0];
    if (!r) throw new Error('no result');
    const meta = r.meta;
    const q = r.indicators?.quote?.[0] || {};
    const closes = (q.close || []).filter(x => x != null && !isNaN(x));
    const highs  = (q.high  || []).filter(x => x != null && !isNaN(x));
    const lows   = (q.low   || []).filter(x => x != null && !isNaN(x));
    const vols   = (q.volume|| []).filter(x => x != null && !isNaN(x));
    if (closes.length < 20) throw new Error('insufficient');

    const last = closes.at(-1);
    const prev = closes.at(-2) ?? last;
    const pct  = ((last - prev) / prev) * 100;
    const e3   = ema(closes, 3);
    const e5   = ema(closes, 5);
    const e10  = ema(closes, 10);
    const e20  = ema(closes, 20);
    const s50  = sma(closes, 50);
    const s100 = sma(closes, 100);
    const s200 = sma(closes, 200);
    const rsiVal  = rsi14(closes);
    const stochVal = stochRSI(closes);
    const atr  = calcATR(highs, lows, closes, 14);
    const adr  = calcADR(highs, lows, 14);

    const lastVol = vols.at(-1) ?? 0;
    const lastValue = lastVol * last;
    const avg20Vol  = vols.length >= 20 ? vols.slice(-20).reduce((a,b)=>a+b,0)/20 : lastVol;
    const avg20Value = avg20Vol * last;
    const pct1avg20 = avg20Value * 0.01;

    // MA above/below
    const maStatus = {
      ema3: last > e3, ema5: last > e5, ema10: last > e10, ema20: last > e20,
      sma50: last > s50, sma100: last > s100, sma200: last > s200
    };

    // Bull/Bear count (7 MA + RSI + StochRSI)
    let bull = 0, bear = 0;
    Object.values(maStatus).forEach(v => { if(v===true) bull++; else if(v===false) bear++; });
    if (rsiVal !== null) { if(rsiVal>50) bull++; else bear++; }
    if (stochVal !== null) { if(stochVal>50) bull++; else bear++; }

    return {
      ticker,
      company: meta.longName || meta.shortName || ticker,
      price: last, pct,
      e3, e5, e10, e20, s50, s100, s200,
      maStatus, aboveAll4: maStatus.ema3 && maStatus.ema5 && maStatus.ema10 && maStatus.ema20,
      rsi: rsiVal, stochRsi: stochVal, atr, adr,
      lastValue, avg20Value, pct1avg20,
      bull, bear
    };
  } catch { return null; }
}

async function startFetch() {
  if (isFetching) return;
  isFetching = true;
  const btn = document.getElementById('fetchBtn');
  btn.disabled = true;
  btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="animation:spin 0.7s linear infinite"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg> Mengambil...`;

  const style = document.createElement('style');
  style.textContent = '@keyframes spin{to{transform:rotate(360deg)}}';
  document.head.appendChild(style);

  setProgress(3);
  setDot('loading');
  document.getElementById('fetchStatus').style.display = 'flex';
  document.getElementById('statsRow').style.display = 'flex';

  allData = [];
  const BATCH = 8;
  const total = TICKERS.length;
  let done = 0;

  for (let i = 0; i < total; i += BATCH) {
    const chunk = TICKERS.slice(i, i + BATCH);
    const results = await Promise.allSettled(chunk.map(t => fetchOne(t)));
    results.forEach(r => { if (r.status === 'fulfilled' && r.value) allData.push(r.value); done++; });
    const pct = 3 + Math.round((done / total) * 94);
    setProgress(pct);
    document.getElementById('fetchStatusText').innerHTML =
      `Memproses <span class="highlight">${done}/${total}</span> saham ISSI... berhasil: <span class="highlight">${allData.length}</span>`;
    updateStats();
    applyFilters();
    renderTable();
    await delay(40);
  }

  // Persist
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ data: allData, ts: Date.now() }));
  } catch(e) {}

  setProgress(100);
  isFetching = false;
  btn.disabled = false;
  btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg> Ambil Data Saham`;
  setDot('done');
  document.getElementById('fetchStatus').style.display = 'none';
  document.getElementById('lastFetchWrap').style.display = 'flex';
  document.getElementById('lastFetchTime').textContent = 'Diperbarui: ' + new Date().toLocaleString('id-ID');
  document.getElementById('statusText').textContent = `${allData.length} saham berhasil dimuat`;
  toast(`${allData.length} saham berhasil diproses`, 'success');
  setTimeout(() => setProgress(0), 800);
}

function delay(ms) { return new Promise(r => setTimeout(r, ms)); }
function setProgress(p) { document.getElementById('progressFill').style.width = p + '%'; }
function setDot(state) {
  const d = document.getElementById('statusDot');
  d.className = 'meta-dot';
  if (state === 'loading') d.classList.add('loading');
  if (state === 'idle') d.classList.add('idle');
}

// =============================================
// LOAD FROM STORAGE
// =============================================
window.addEventListener('load', () => {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      const parsed = JSON.parse(raw);
      if (parsed.data && parsed.data.length > 0) {
        allData = parsed.data;
        const ago = timeAgo(parsed.ts);
        document.getElementById('statusText').textContent = `${allData.length} saham (cache ${ago})`;
        document.getElementById('lastFetchWrap').style.display = 'flex';
        document.getElementById('lastFetchTime').textContent = 'Cache: ' + new Date(parsed.ts).toLocaleString('id-ID');
        document.getElementById('statsRow').style.display = 'flex';
        setDot('idle');
        updateStats();
        applyFilters();
        renderTable();
        toast(`Data cache dimuat: ${allData.length} saham`, 'info');
        return;
      }
    }
  } catch(e) {}
  setDot('idle');
  document.getElementById('statusText').textContent = 'Belum ada data ‚Äî klik "Ambil Data Saham"';
});

function timeAgo(ts) {
  const diff = Date.now() - ts;
  const h = Math.floor(diff / 3600000);
  const m = Math.floor((diff % 3600000) / 60000);
  if (h > 0) return `${h}j ${m}m lalu`;
  return `${m}m lalu`;
}

// =============================================
// FILTER & SORT
// =============================================
function setSig(f) {
  sigFilter = f;
  ['all','bull','bear','above4','rsi-ob','rsi-os'].forEach(s => {
    document.getElementById('sig-'+s).classList.toggle('active', s === f);
  });
  applyFilters(); renderTable();
}
function toggleMA(key) {
  if (maFilter.has(key)) maFilter.delete(key);
  else maFilter.add(key);
  document.getElementById('maf-'+key).classList.toggle('active', maFilter.has(key));
  applyFilters(); renderTable();
}
function resetMAFilters() {
  maFilter.clear();
  ['ema3','ema5','ema10','ema20','sma50','sma100','sma200'].forEach(k =>
    document.getElementById('maf-'+k).classList.remove('active')
  );
  applyFilters(); renderTable();
}

function applyFilters() {
  const q = document.getElementById('searchInput').value.trim().toUpperCase();
  let d = [...allData];
  if (q) d = d.filter(x => x.ticker.includes(q) || (x.company||'').toUpperCase().includes(q));
  if (sigFilter === 'bull') d = d.filter(x => x.bull > x.bear);
  if (sigFilter === 'bear') d = d.filter(x => x.bear > x.bull);
  if (sigFilter === 'above4') d = d.filter(x => x.aboveAll4);
  if (sigFilter === 'rsi-ob') d = d.filter(x => x.rsi !== null && x.rsi > 70);
  if (sigFilter === 'rsi-os') d = d.filter(x => x.rsi !== null && x.rsi < 30);
  maFilter.forEach(key => { d = d.filter(x => x.maStatus && x.maStatus[key] === true); });
  d.sort((a, b) => {
    let va = a[sortCol] ?? 0, vb = b[sortCol] ?? 0;
    if (sortCol === 'ticker' || sortCol === 'company') {
      va = String(va); vb = String(vb);
      return va.localeCompare(vb) * sortDir;
    }
    return (va - vb) * sortDir;
  });
  displayData = d;
  document.getElementById('st-shown').textContent = d.length;
}

function sortBy(col) {
  if (sortCol === col) sortDir *= -1; else { sortCol = col; sortDir = -1; }
  document.querySelectorAll('thead th').forEach(th => th.classList.remove('sort-asc','sort-desc'));
  const thMap = { ticker:1, company:2, price:3, pct:4, rsi:6, stochRsi:7, atr:8, adr:9, lastValue:10, avg20Value:11, pct1avg20:12 };
  const idx = thMap[col];
  if (idx !== undefined) {
    const ths = document.querySelectorAll('thead th');
    ths[idx].classList.add(sortDir === 1 ? 'sort-asc' : 'sort-desc');
  }
  applyFilters(); renderTable();
}

function updateStats() {
  document.getElementById('st-total').textContent = allData.length;
  document.getElementById('st-bull').textContent = allData.filter(x => x.bull > x.bear).length;
  document.getElementById('st-bear').textContent = allData.filter(x => x.bear > x.bull).length;
  document.getElementById('st-above').textContent = allData.filter(x => x.aboveAll4).length;
}

// =============================================
// FORMAT HELPERS
// =============================================
function fN(v, d=0) {
  if (v == null || isNaN(v)) return '‚Äî';
  return v.toLocaleString('id-ID', { minimumFractionDigits: d, maximumFractionDigits: d });
}
function fB(v) {
  if (v == null || isNaN(v) || v === 0) return '‚Äî';
  if (v >= 1e12) return (v/1e12).toFixed(2) + ' T';
  if (v >= 1e9)  return (v/1e9).toFixed(2) + ' M';
  if (v >= 1e6)  return (v/1e6).toFixed(1) + ' Jt';
  return fN(v);
}
function fPct(v) {
  if (v == null || isNaN(v)) return '‚Äî';
  const s = v >= 0 ? '+' : '';
  return s + v.toFixed(2) + '%';
}
function rsiColor(v) {
  if (v == null) return '#8a919e';
  if (v > 70) return 'var(--red)';
  if (v < 30) return 'var(--green)';
  if (v > 55) return 'var(--green)';
  if (v < 45) return 'var(--red)';
  return 'var(--text2)';
}

// =============================================
// RENDER
// =============================================
function renderTable() {
  const tbody = document.getElementById('tableBody');
  if (displayData.length === 0) {
    tbody.innerHTML = `<tr><td colspan="13"><div class="table-empty"><div class="icon">${isFetching ? '‚ü≥' : '‚àÖ'}</div>${isFetching ? 'Mengambil data...' : 'Tidak ada data yang sesuai filter'}</div></td></tr>`;
    return;
  }
  const MA_LABELS = ['E3','E5','E10','E20','S50','S100','S200'];
  const MA_KEYS   = ['ema3','ema5','ema10','ema20','sma50','sma100','sma200'];

  tbody.innerHTML = displayData.map((d, i) => {
    const pUp = d.pct >= 0;
    const maPips = MA_KEYS.map((k, ki) => {
      const v = d.maStatus?.[k];
      if (v == null) return `<span class="ma-pip" style="background:var(--bg3);color:var(--text3)">‚Äî</span>`;
      return `<span class="ma-pip ${v ? 'above' : 'below'}" title="${k.toUpperCase()}: harga ${v ? 'di atas' : 'di bawah'}">${MA_LABELS[ki]}</span>`;
    }).join('');

    const rsiPct = d.rsi != null ? Math.min(100, Math.max(0, d.rsi)) : 0;
    const stochPct = d.stochRsi != null ? Math.min(100, Math.max(0, d.stochRsi)) : 0;
    const rsiC = rsiColor(d.rsi);
    const stochC = rsiColor(d.stochRsi);
    const bullBear = d.bull > d.bear ? 'badge-bull' : d.bear > d.bull ? 'badge-bear' : 'badge-neu';

    return `<tr>
      <td class="td-no">${i+1}</td>
      <td class="td-ticker">${d.ticker}</td>
      <td class="td-company" title="${d.company||''}">${d.company||'‚Äî'}</td>
      <td class="td-price">${fN(d.price,0)}</td>
      <td class="td-pct ${pUp?'up':'down'}">${fPct(d.pct)}</td>
      <td><div class="ma-cell">${maPips}</div></td>
      <td>
        <div class="rsi-wrap">
          <div class="rsi-bar"><div class="rsi-fill" style="width:${rsiPct}%;background:${rsiC}"></div></div>
          <span style="color:${rsiC};font-family:var(--mono);font-size:0.73rem">${d.rsi!=null?d.rsi.toFixed(1):'‚Äî'}</span>
        </div>
      </td>
      <td>
        <div class="rsi-wrap">
          <div class="rsi-bar"><div class="rsi-fill" style="width:${stochPct}%;background:${stochC}"></div></div>
          <span style="color:${stochC};font-family:var(--mono);font-size:0.73rem">${d.stochRsi!=null?d.stochRsi.toFixed(1):'‚Äî'}</span>
        </div>
      </td>
      <td class="td-ind">${fN(d.atr,1)}</td>
      <td class="td-ind ${d.adr!=null ? (d.adr>3?'up':d.adr<1?'down':'')  :''}">${d.adr!=null?d.adr.toFixed(2)+'%':'‚Äî'}</td>
      <td class="td-val">${fB(d.lastValue)}</td>
      <td class="td-val">${fB(d.avg20Value)}</td>
      <td class="td-val" style="color:var(--accent)">${fB(d.pct1avg20)}</td>
    </tr>`;
  }).join('');
}

// =============================================
// TOAST
// =============================================
function toast(msg, type='info') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.getElementById('toastWrap').appendChild(el);
  requestAnimationFrame(() => { requestAnimationFrame(() => el.classList.add('show')); });
  setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 400); }, 3000);
}
</script>
</body>
</html>
